** Programmed by Min-Hyung Kim
** Please find the most updated program at the following URL:
** https://github.com/mkim0710/causal-inference-book/blob/master/data/standardization_nonparametric.do


** The dataset nhefs.dta is from the following reference:  
** HernÃ¡n MA, Robins JM (2019). Causal Inference. Boca Raton: Chapman & Hall/CRC, forthcoming. 
** https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/


clear
webuse set "https://github.com/mkim0710/causal-inference-book/raw/master/data"
webuse "nhefs.dta"
gen age_gt50 = (age > 50 & age <.)
drop if wt82_71 == .
global varname4id seqn
global varname4outcome wt82_71
global varname4tx qsmk
global varname4confounder age_gt50
preserve
collapse (count) n = $varname4id (mean) E_outcome = $varname4outcome, by($varname4tx $varname4confounder)
egen total = sum(n)
egen n_by_confounder = sum(n), by($varname4confounder)
egen E_outcome_by_tx = sum(E_outcome * n_by_confounder / total), by($varname4tx)
egen tmp_min = min(E_outcome_by_tx)
egen tmp_max = max(E_outcome_by_tx)
gen diff = tmp_max - tmp_min
drop tmp*
list
restore, preserve
/*

     +----------------------------------------------------------------------------+
     | qsmk   older     n      E_outcome   total   n_by_c~r   E_outc~x       diff |
     |----------------------------------------------------------------------------|
  1. |    0       0   851    2.991448404    1566       1098   1.869721   3.004455 |
  2. |    0       1   312   -.7620255091    1566        468   1.869721   3.004455 |
  3. |    1       0   247    6.056408169    1566       1098   4.874175   3.004455 |
  4. |    1       1   156    2.100474456    1566        468   4.874175   3.004455 |
     +----------------------------------------------------------------------------+
*/


global varname4id seqn
global varname4outcome wt82_71
global varname4tx qsmk
global varname4confounder age_gt50 sex race exercise
preserve
collapse (count) n = $varname4id (mean) E_outcome = $varname4outcome, by($varname4tx $varname4confounder)
egen total = sum(n)
egen n_by_confounder = sum(n), by($varname4confounder)
egen E_outcome_by_tx = sum(E_outcome * n_by_confounder / total), by($varname4tx)
egen tmp_min = min(E_outcome_by_tx)
egen tmp_max = max(E_outcome_by_tx)
gen diff = tmp_max - tmp_min
drop tmp*
list
restore, preserve
/*

     +-------------------------------------------------------------------------------------------------------+
     | qsmk   sex   race   exercise   age_gt50     n      E_outcome   total   n_by_c~r   E_outc~x       diff |
     |-------------------------------------------------------------------------------------------------------|
  1. |    0     0      0          0          0   101    3.537857422    1566        130   1.862132   2.879503 |
  2. |    0     0      0          1          0   142    2.414087683    1566        201   1.862132   2.879503 |
  3. |    0     0      0          2          0    93    3.556579465    1566        128   1.862132   2.879503 |
  4. |    0     0      1          0          0    10    5.601268774    1566         11   1.862132   2.879503 |
  5. |    0     0      1          1          0    15    4.219117359    1566         18   1.862132   2.879503 |
     |-------------------------------------------------------------------------------------------------------|
  6. |    0     0      1          2          0    22    .4953596214    1566         27   1.862132   2.879503 |
  7. |    0     1      0          0          0    77    3.416986721    1566         89   1.862132   2.879503 |
  8. |    0     1      0          1          0   173    2.924952613    1566        221   1.862132   2.879503 |
  9. |    0     1      0          2          0   142    2.543295428    1566        182   1.862132   2.879503 |
 10. |    0     1      1          0          0     3   -.3419263133    1566          4   1.862132   2.879503 |
     |-------------------------------------------------------------------------------------------------------|
 11. |    0     1      1          1          0    26    4.387699885    1566         34   1.862132   2.879503 |
 12. |    0     1      1          2          0    47    3.006641333    1566         53   1.862132   2.879503 |
 13. |    0     0      0          0          1    34   -.3238813235    1566         43   1.862132   2.879503 |
 14. |    0     0      0          1          1    52    .1741046608    1566         87   1.862132   2.879503 |
 15. |    0     0      0          2          1    47   -.6035261889    1566         83   1.862132   2.879503 |
     |-------------------------------------------------------------------------------------------------------|
 16. |    0     0      1          0          1     5    1.496644264    1566          6   1.862132   2.879503 |
 17. |    0     0      1          1          1    10   -1.859219389    1566         13   1.862132   2.879503 |
 18. |    0     0      1          2          1    11   -3.175158183    1566         15   1.862132   2.879503 |
 19. |    0     1      0          0          1     7   -3.611980141    1566         17   1.862132   2.879503 |
 20. |    0     1      0          1          1    63    -.907616999    1566         83   1.862132   2.879503 |
     |-------------------------------------------------------------------------------------------------------|
 21. |    0     1      0          2          1    62   -.5156932158    1566         96   1.862132   2.879503 |
 22. |    0     1      1          1          1     4     -.14320473    1566          4   1.862132   2.879503 |
 23. |    0     1      1          2          1    17   -2.728380148    1566         21   1.862132   2.879503 |
 24. |    1     0      0          0          0    29    5.807407729    1566        130   4.741635   2.879503 |
 25. |    1     0      0          1          0    59    6.294535224    1566        201   4.741635   2.879503 |
     |-------------------------------------------------------------------------------------------------------|
 26. |    1     0      0          2          0    35    6.217337907    1566        128   4.741635   2.879503 |
 27. |    1     0      1          0          0     1     6.91750614    1566         11   4.741635   2.879503 |
 28. |    1     0      1          1          0     3     2.61054159    1566         18   4.741635   2.879503 |
 29. |    1     0      1          2          0     5    11.97600773    1566         27   4.741635   2.879503 |
 30. |    1     1      0          0          0    12    5.557640972    1566         89   4.741635   2.879503 |
     |-------------------------------------------------------------------------------------------------------|
 31. |    1     1      0          1          0    48    6.658495057    1566        221   4.741635   2.879503 |
 32. |    1     1      0          2          0    40    5.193554455    1566        182   4.741635   2.879503 |
 33. |    1     1      1          0          0     1      6.9140162    1566          4   4.741635   2.879503 |
 34. |    1     1      1          1          0     8    7.243761889    1566         34   4.741635   2.879503 |
 35. |    1     1      1          2          0     6    .8331125333    1566         53   4.741635   2.879503 |
     |-------------------------------------------------------------------------------------------------------|
 36. |    1     0      0          0          1     9    .5555661233    1566         43   4.741635   2.879503 |
 37. |    1     0      0          1          1    35    1.437978976    1566         87   4.741635   2.879503 |
 38. |    1     0      0          2          1    36    4.296032386    1566         83   4.741635   2.879503 |
 39. |    1     0      1          0          1     1     2.49944186    1566          6   4.741635   2.879503 |
 40. |    1     0      1          1          1     3     7.06727184    1566         13   4.741635   2.879503 |
     |-------------------------------------------------------------------------------------------------------|
 41. |    1     0      1          2          1     4    -.651555135    1566         15   4.741635   2.879503 |
 42. |    1     1      0          0          1    10    3.174573974    1566         17   4.741635   2.879503 |
 43. |    1     1      0          1          1    20     2.05178521    1566         83   4.741635   2.879503 |
 44. |    1     1      0          2          1    34    .2234850209    1566         96   4.741635   2.879503 |
 45. |    1     1      1          2          1     4    4.053129605    1566         21   4.741635   2.879503 |
     +-------------------------------------------------------------------------------------------------------+

*/
